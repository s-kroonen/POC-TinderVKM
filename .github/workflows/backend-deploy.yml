name: Backend Deploy

on:
    push:
        paths:
            - "backend/**"
            - ".github/workflows/backend-deploy.yml"
        branches:
            - main
    workflow_dispatch:

jobs:
    backend:
        name: Build & Test Backend
        runs-on: ubuntu-latest
        defaults:
            run:
                working-directory: ./backend

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: 20

            - name: Install dependencies
              run: npm ci

            - name: Lint
              run: npm run lint --if-present

            - name: Run backend build
              run: npm run build

            - name: Run backend tests
              run: |
                  echo "Running backend tests..."
                  for i in 1 2 3; do
                    npm test && break || (echo "Retrying tests ($i/3)" && sleep 5)
                  done
    deploy:
        name: Deploy Backend Stack
        runs-on: ubuntu-latest
        needs: backend
        if: ${{ success() }}
        steps:
            - name: Trigger Portainer Backend Deploy
              run: |
                  echo "Deploying backend stack..."
                  curl -s -X POST "${{ secrets.PORTAINER_BACKEND_WEBHOOK }}" || exit 1
